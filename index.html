<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Arcane Forest Dino Style</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom, #0a2a2a, #0a1a1a);
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: linear-gradient(to bottom, #0a2a2a, #0a1a1a);
      width: 100vw;
      height: 100vh;
    }
    .startScreen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #a0e6d2;
      font-size: clamp(20px, 5vw, 40px);
      background: rgba(10, 30, 30, 0.85);
      padding: 15px 30px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 0 20px rgba(0, 255, 150, 0.3);
      border: 1px solid #00b37d;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div class="startScreen" id="startScreen">
    Enter the Forest
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startScreen = document.getElementById("startScreen");

    // Proměnné, které se přepočítají podle velikosti
    let ground, raven, baseSpeed, obstacles, skyObjects, stars, clouds, trees, smokeParticles;

    // Proměnné pro zimní level
    let winterMode = false;
    let pitCounter = 0; // počet po sobě jdoucích propastí
    let fallingDown = false; // zda právě padá dolů
    let fallSpeed = 0; // rychlost pádu dolů
    let fallFrame = 0; // počet snímků pádu
    let fallDuration = 30; // 30 snímků = ~0.5 sekundy při 60 FPS

    // Proměnné pro minci
    let coin = null; // mince v zimním prostředí
    let coinCollected = false; // zda je mince sebraná

    // Přizpůsobení velikosti displeje
    function resizeGame() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      // Přepočet proměnných podle velikosti
      ground = canvas.height - 100;
      raven = {
        x: 100,
        y: ground - 80,
        width: 80,
        height: 80,
        gravity: 0.8,
        lift: -17, // Vyšší skok
        velocity: 0,
        jumping: false
      };

      baseSpeed = 6;
      obstacles = [];
      skyObjects = [];
      stars = [];
      clouds = [];
      trees = [];
      smokeParticles = [];

      // Reset pozadí
      for (let i = 0; i < 100; i++) stars.push({x: Math.random() * canvas.width, y: Math.random() * canvas.height / 2, radius: Math.random() * 2, alpha: Math.random()});
      for (let i = 0; i < 10; i++) clouds.push({x: Math.random() * canvas.width, y: 50 + Math.random() * 100, width: 100 + Math.random() * 50, height: 50 + Math.random() * 30, speed: baseSpeed * 0.5});
      for (let i = 0; i < 15; i++) {
        let treeWidth = 20 + Math.random() * 40;
        let treeHeight = 80 + Math.random() * 120;
        let treeX = Math.random() * canvas.width;
        let treeSpeed = baseSpeed * 0.7 + Math.random() * 0.5;
        trees.push({x: treeX, y: ground, width: treeWidth, height: treeHeight, speed: treeSpeed});
      }
    }

    window.addEventListener("resize", resizeGame);
    window.addEventListener("load", resizeGame);
    resizeGame();

    // =============== Images (z GitHub Pages) ===================
    const ravenImg = new Image();
    ravenImg.src = "https://aforests25.github.io/AF-Game/raven.png";
    ravenImg.onload = () => console.log("✅ Raven obrázek načten");
    ravenImg.onerror = () => console.log("❌ Chyba: Raven obrázek nenalezen");

    const obstacleImg = new Image();
    obstacleImg.src = "https://aforests25.github.io/AF-Game/obstacle.png";
    obstacleImg.onload = () => console.log("✅ Obstacle obrázek načten");
    obstacleImg.onerror = () => console.log("❌ Chyba: Obstacle obrázek nenalezen");

    // =============== Sounds ===================
    const jumpSound = new Audio("jump.wav");
    const pointSound = new Audio("point.wav");
    const hitSound = new Audio("hit.wav");
    const coinSound = new Audio("coin.wav"); // přidej si soubor coin.wav

    // =============== Obstacles ===================
    let frame = 0;
    let score = 0;
    let gameOver = false;
    let speedMultiplier = 1;

    // =============== Smoke ===================
    function addSmoke(x, y) {
      smokeParticles.push({
        x: x,
        y: y,
        radius: 5,
        alpha: 1,
        rise: 0.5 + Math.random() * 0.5,
        shrink: 0.05 + Math.random() * 0.02
      });
    }
    function drawSmoke() {
      for (let i = smokeParticles.length - 1; i >= 0; i--) {
        const p = smokeParticles[i];
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(160, 230, 210, ${p.alpha})`;
        ctx.fill();
        ctx.closePath();
        p.y -= p.rise;
        p.radius -= p.shrink;
        p.alpha -= 0.02;
        if (p.radius <= 0 || p.alpha <= 0) smokeParticles.splice(i, 1);
      }
    }

    // =============== Controls ===================
    function jump() {
      if (!gameOver && !raven.jumping && !fallingDown) {
        raven.velocity = raven.lift;
        raven.jumping = true;
        jumpSound.play().catch(e => console.log("Zvuk nelze přehrát"));
        for (let i = 0; i < 3; i++) addSmoke(raven.x + raven.width - 10 + i * 2, raven.y + 20 + i * 2);
      }
      if (gameOver) restartGame();
    }
    window.addEventListener("keydown", e => {
      if (e.code === "Space") jump();
    });
    window.addEventListener("touchstart", (e) => {
      e.preventDefault();
      jump();
    });

    // =============== Sky Objects ===================
    function addSkyObject() {
      const type = Math.random() < 0.4 ? "comet" : Math.random() < 0.7 ? "probe" : "ufo";
      const x = Math.random() < 0.5 ? -50 : canvas.width + 50;
      const y = Math.random() * canvas.height / 2;
      const speed = 2 + Math.random() * 4;
      const direction = x < 0 ? 1 : -1;

      skyObjects.push({
        x: x,
        y: y,
        type: type,
        speed: speed,
        direction: direction,
        size: 5 + Math.random() * 10
      });
    }

    function drawSkyObjects() {
      skyObjects.forEach(obj => {
        if (obj.type === "comet") {
          ctx.beginPath();
          ctx.arc(obj.x, obj.y, obj.size / 2, 0, Math.PI * 2);
          ctx.fillStyle = "#a0e6d2";
          ctx.fill();

          ctx.beginPath();
          ctx.moveTo(obj.x, obj.y);
          ctx.lineTo(obj.x - 10 * obj.direction, obj.y - 5);
          ctx.lineTo(obj.x - 20 * obj.direction, obj.y);
          ctx.lineTo(obj.x - 10 * obj.direction, obj.y + 5);
          ctx.closePath();
          ctx.fillStyle = "rgba(160, 230, 210, 0.3)";
          ctx.fill();
        } else if (obj.type === "probe") {
          ctx.fillStyle = "#555";
          ctx.fillRect(obj.x - obj.size / 2, obj.y - obj.size / 2, obj.size, obj.size);
        } else if (obj.type === "ufo") {
          ctx.beginPath();
          ctx.ellipse(obj.x, obj.y, obj.size, obj.size / 2, 0, 0, Math.PI * 2);
          ctx.fillStyle = "#33ccff";
          ctx.fill();

          ctx.beginPath();
          ctx.arc(obj.x, obj.y - obj.size / 3, obj.size / 3, 0, Math.PI * 2);
          ctx.fillStyle = "#a0e6d2";
          ctx.fill();
        }
      });
    }

    function updateSkyObjects() {
      for (let i = skyObjects.length - 1; i >= 0; i--) {
        const obj = skyObjects[i];
        obj.x += obj.speed * obj.direction;

        if ((obj.direction === 1 && obj.x > canvas.width + 50) || (obj.direction === -1 && obj.x < -50)) {
          skyObjects.splice(i, 1);
        }
      }

      if (Math.random() < 0.01) {
        addSkyObject();
      }
    }

    // =============== Background ===================
    function drawBackground() {
      if (winterMode || fallingDown) {
        // Zimní pozadí
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, "#a0c8e0");
        gradient.addColorStop(1, "#d0e6f0");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Sněhové hvězdičky
        stars.forEach(s => {
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${s.alpha})`;
          ctx.fill();
          ctx.closePath();
          s.x -= baseSpeed * 0.2;
          if (s.x < 0) s.x = canvas.width;
        });
      } else {
        // Normální pozadí
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, "#0a2a2a");
        gradient.addColorStop(1, "#0a1a1a");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        stars.forEach(s => {
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(160, 230, 210, ${s.alpha})`;
          ctx.fill();
          ctx.closePath();
          s.x -= baseSpeed * 0.2;
          if (s.x < 0) s.x = canvas.width;
        });
      }

      clouds.forEach(c => {
        ctx.fillStyle = winterMode || fallingDown ? "rgba(255, 255, 255, 0.5)" : "rgba(160, 230, 210, 0.2)";
        ctx.beginPath();
        ctx.ellipse(c.x, c.y, c.width, c.height, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.closePath();
        c.x -= c.speed;
        if (c.x + c.width < 0) c.x = canvas.width + c.width;
      });

      trees.forEach(t => {
        if (winterMode || fallingDown) {
          ctx.fillStyle = "#a0c8e0";
        } else {
          ctx.fillStyle = "#023a2a";
        }
        ctx.beginPath();
        ctx.moveTo(t.x, t.y);
        ctx.lineTo(t.x + t.width, t.y);
        ctx.lineTo(t.x + t.width / 2, t.y - t.height);
        ctx.closePath();
        ctx.fill();
        t.x -= t.speed;
        if (t.x + t.width < 0) t.x = canvas.width;
      });

      ctx.fillStyle = (winterMode || fallingDown) ? "rgba(200, 200, 200, 0.6)" : "rgba(0, 0, 0, 0.6)";
      ctx.font = "bold 80px 'Brush Script MT', cursive";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("Arcane Forest", canvas.width / 2, canvas.height / 2.5);
    }

    // =============== Draw Functions ===================
    function drawRaven() {
      if (ravenImg.complete && ravenImg.naturalWidth !== 0) {
        ctx.drawImage(ravenImg, raven.x, raven.y, raven.width, raven.height);
      } else {
        ctx.fillStyle = (winterMode || fallingDown) ? "#88ccee" : "#00b37d";
        ctx.beginPath();
        ctx.arc(raven.x + raven.width/2, raven.y + raven.height/2, raven.width/2, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function drawObstacles() {
      obstacles.forEach(obs => {
        if (obs.type === "pit") {
          ctx.fillStyle = (winterMode || fallingDown) ? "#000066" : "#000";
          ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
        } else if (obs.type === "coin") {
          ctx.fillStyle = "#ffcc00";
          ctx.beginPath();
          ctx.arc(obs.x + obs.width/2, obs.y + obs.height/2, obs.width/2, 0, Math.PI * 2);
          ctx.fill();
        } else {
          if (obstacleImg.complete && obstacleImg.naturalWidth !== 0) {
            ctx.drawImage(obstacleImg, obs.x, obs.y, obs.width, obs.height);
          } else {
            ctx.fillStyle = (winterMode || fallingDown) ? "#66aaff" : "#006644";
            ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
          }
        }
      });
    }

    function updateObstacles() {
      // Dynamická rychlost podle skóre
      if (score < 10) {
        speedMultiplier = 1 + score * 0.02; // Každý bod zrychlí o 0.02
      } else {
        speedMultiplier = 1 + 10 * 0.02 + (score - 10) * 0.01; // Po 10 bodech zrychlí pomaleji (0.01 za bod)
      }

      if (frame % 120 === 0) {
        let createPit = Math.random() < 0.5;
        if (createPit) {
          let newPit = {
            x: canvas.width,
            y: ground,
            width: 80 + Math.random() * 40,
            height: 10,
            type: "pit",
            passed: false,
            special: pitCounter === 2 // Třetí propast je speciální (počítáme od 0)
          };
          obstacles.push(newPit);
          pitCounter++;
        } else {
          // Pokud je zima a skóre je alespoň 15, přidej minci
          if (winterMode && score >= 15 && Math.random() < 0.2) {
            obstacles.push({
              x: canvas.width,
              y: ground - 100,
              width: 30,
              height: 30,
              type: "coin",
              passed: false
            });
          } else {
            obstacles.push({
              x: canvas.width,
              y: ground - 50,
              width: 40,
              height: 80,
              passed: false,
              type: "block"
            });
          }
          pitCounter = 0; // Resetujeme počítadlo
        }
      }
      obstacles.forEach(obs => {
        obs.x -= baseSpeed * speedMultiplier;
      });
    }

    function updateRaven() {
      if (fallingDown) {
        raven.y += fallSpeed;
        fallSpeed += 0.5;
        fallFrame++;
        // Pokud animace trvala dostatečně dlouho
        if (fallFrame >= fallDuration) {
          winterMode = true;
          fallingDown = false;
          pitCounter = 0;
          fallFrame = 0;
          // Reset pozice ravenu
          raven.y = ground - 80;
        }
      } else {
        raven.velocity += raven.gravity;
        raven.y += raven.velocity;
        if (raven.y + raven.height >= ground) {
          raven.y = ground - raven.height;
          raven.velocity = 0;
          raven.jumping = false;
        }
      }
    }

    function checkCollisions() {
      // MENŠÍ HITBOX PRO RAVENA
      let ravenHitboxWidth = raven.width * 0.8; // 80 % šířky
      let ravenHitboxHeight = raven.height * 0.8; // 80 % výšky
      let ravenHitboxX = raven.x + (raven.width - ravenHitboxWidth) / 2;
      let ravenHitboxY = raven.y + (raven.height - ravenHitboxHeight) / 2;

      for (let obs of obstacles) {
        if (obs.type === "pit") {
          if (
            ravenHitboxX + ravenHitboxWidth > obs.x &&
            ravenHitboxX < obs.x + obs.width &&
            ravenHitboxY + ravenHitboxHeight >= obs.y &&
            !raven.jumping
          ) {
            // Pokud je to speciální 3. propast
            if (obs.special && !fallingDown) {
              fallingDown = true;
              fallSpeed = 5; // začne padat dolů
              pitCounter = 0;
              return;
            } else if (!obs.special) {
              // Jinak zabije hru
              gameOver = true;
              hitSound.play().catch(e => console.log("Zvuk nelze přehrát"));
            }
          }
        } else if (obs.type === "coin") {
          // Kolize s mincí
          let dx = (raven.x + raven.width/2) - (obs.x + obs.width/2);
          let dy = (raven.y + raven.height/2) - (obs.y + obs.height/2);
          let distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < raven.width/2 + obs.width/2) {
            coinSound.play().catch(e => console.log("Zvuk nelze přehrát"));
            winterMode = false; // Vrátíme se do původního prostředí
            obstacles = []; // Odstraníme překážky
            coin = null; // Resetujeme minci
            return;
          }
        } else {
          // MENŠÍ HITBOX PRO PŘEKÁŽKY
          let hitboxWidth = obs.width * 0.6; // 60 % šířky
          let hitboxX = obs.x + (obs.width - hitboxWidth) / 2; // střed

          if (
            ravenHitboxX + ravenHitboxWidth > hitboxX &&
            ravenHitboxX < hitboxX + hitboxWidth &&
            ravenHitboxY < obs.y + obs.height &&
            ravenHitboxY + ravenHitboxHeight > obs.y
          ) {
            gameOver = true;
            hitSound.play().catch(e => console.log("Zvuk nelze přehrát"));
          }
        }
        if (!obs.passed && obs.x + obs.width < raven.x) {
          obs.passed = true;
          if (obs.type !== "coin") {
            score++;
            pointSound.play().catch(e => console.log("Zvuk nelze přehrát"));
          }
        }
      }
    }

    function drawScore() {
      ctx.fillStyle = (winterMode || fallingDown) ? "#003366" : "#a0e6d2";
      ctx.font = "40px Arial Black";
      ctx.textAlign = "center";
      ctx.fillText(score, canvas.width / 2, 60);
    }

    function drawGround() {
      ctx.fillStyle = (winterMode || fallingDown) ? "#a0c8e0" : "#004d3a";
      ctx.fillRect(0, ground, canvas.width, 10);
    }

    function loop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBackground();
      updateSkyObjects();
      drawSkyObjects();

      if (!gameOver) {
        updateRaven();
        updateObstacles();
        checkCollisions();
        drawGround();
        drawObstacles();
        drawRaven();
        if (frame % 5 === 0) addSmoke(raven.x + raven.width - 10, raven.y + 20);
        drawSmoke();
        drawScore();
        frame++;
        requestAnimationFrame(loop);
      } else {
        ctx.fillStyle = "#ff3366";
        ctx.font = "60px Arial Black";
        ctx.textAlign = "center";
        ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2);
        ctx.fillStyle = (winterMode || fallingDown) ? "#003366" : "#a0e6d2";
        ctx.fillText("Skóre: " + score, canvas.width / 2, canvas.height / 2 + 80);
        ctx.font = "30px Arial";
        ctx.fillText("Stiskni mezerník nebo tapni pro restart", canvas.width / 2, canvas.height / 2 + 130);
      }
    }

    function restartGame() {
      obstacles = [];
      frame = 0;
      score = 0;
      speedMultiplier = 1;
      gameOver = false;
      winterMode = false;
      pitCounter = 0;
      fallingDown = false;
      fallFrame = 0;
      coin = null;
      coinCollected = false;
      raven.y = ground - raven.height;
      raven.velocity = 0;
      loop();
    }

    // =============== Start Game ===================
    startScreen.addEventListener("click", () => {
      startScreen.style.display = "none";
      loop();
    });

    // Ladění
    ravenImg.onerror = () => console.log("Chyba: raven.png nenalezen");
    obstacleImg.onerror = () => console.log("Chyba: obstacle.png nenalezen");
  </script>
</body>
</html>
